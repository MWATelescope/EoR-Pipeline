params {
    obsids_path = 'obsids.csv'
    quality_updates_path = 'quality-updates.csv'
    tile_updates_path = 'tile-updates.csv'

    // filter obsids
    filter_pointings = [0,2,4]
    // filter_bad_tile_frac = 1.01/128 // stage 1 (0.79%)
    // filter_bad_tile_frac = 2.01/128 // stage 2 (1.57%)
    // filter_bad_tile_frac = 3.01/128 // stage 3 (2.35%)
    // filter_bad_tile_frac = 5.01/128 // stage 4 (3.91%)
    // filter_bad_tile_frac = 7.01/128 // stage 5 (5.48%)
    // filter_bad_tile_frac = 32.01/128 // max (12.5%)
    filter_bad_tile_frac = 1 // inf
    // filter_dead_dipole_frac = 36.01/(16*256) // stage Na (0.89%)
    // filter_dead_dipole_frac = 80.01/(16*256) // max (1.95%)
    filter_dead_dipole_frac = 1 // inf
    // max filtered: 6291
    // stage1b: 1 tiles, 80 dips: 1092
    // stage2a: 2 tiles, 36 dips: 1847
    // stage2b: 2 tiles, 80 dips: 2080
    // stage3a: 3 tiles, 36 dips: 2946
    filter_quality = 1

    // asvo
    asvo_api_key = 'EMPTY'

    // prep
    noprep = false
    prep_time_res_s = 2
    prep_freq_res_khz = 40
    // prep_freq_res_khz = 80

    // flag qa
    noflag = false
    flag_occupancy_threshold = 0.25

    // cal
    nocal = false
    nopoly = true
    cal_suffix = ''
    // - key: short name that appears in calibration solution filename
    // - value: args for hyperdrive di-cal
    dical_args = [
        "30l_src4k": "--uvw-min 30l -n 4000",
        // "30l_src1k": "--uvw-min 30l -n 1000",
        // "30l_src400": "--uvw-min 30l -n 400",
        // "30l_src100": "--uvw-min 30l -n 100",
        // "30l_src4k_fast": "--uvw-min 30l -n 4000 --max-iterations 10 --stop-thresh 1e-6 --min-thresh 1e-2",
        // "30l_src10_fast": "--uvw-min 30l -n 10 --max-iterations 10 --stop-thresh 1e-6 --min-thresh 1e-2",
        // "30l_src4_fast": "--uvw-min 30l -n 4 --max-iterations 10 --stop-thresh 1e-6 --min-thresh 1e-2",
    ]

    // apply
    noapply = false
    nosub = false
    // - key: name of calibration
    // - value[0]: short name that appears in apply
    // - value[1]: args for hyperdrive apply
    apply_args = [
        // "30l_src4k": ["2s_80kHz", "--time-average 2s --freq-average 80kHz"],
        "poly_30l_src4k": ["8s_80kHz", "--time-average 8s --freq-average 80kHz"],
        "30l_src4k": ["8s_80kHz", "--time-average 8s --freq-average 80kHz"],
    ]

    // file types
    noms = false
    nouv = false

    // imaging
    noimg = false
    img_suffix = ''
    img_size = 2048
    img_scale = '40asec'
    img_niter = 0
    img_auto_threshold = 1
    img_auto_mask = 5
    img_mem = 100
    img_channels_out = '24'

    // results
    result_suffix = ''

    // archive
    // use `--archive=true` to enable archiving
    archive = false
    bucket_prefix = "mwaeor:high0"
    // bucket_prefix = "dev:mwaeor0high"

    // defaults for shims
    hyperdrive = 'hyperdrive'
    birli = 'birli'
    giant_squid = 'giant-squid'
    jq = 'jq'
    proxy_prelude = ''
    astro_conda = ''
}
profiles {
    dug {
        singularity {
            cacheDir = '/data/curtin_mwaeor/singularity'
        }
        executor {
            $slurm {
                queueSize = 200
                // submitRateLimit = '1/30s'
                jobName = { "nf-${task.process.split(':')[-1]}.${task.tag}" }
                exitReadTimeout = '5min'
            }
        }
        process {
            scratch = '$TMPDIR_SHM'
            executor = 'slurm'
            queue = 'curtin_mwaeor'
            cpus = 18
            memory = '60G'
            clusterOptions = '--constraint=knl&nogpu'
            errorStrategy = 'ignore'
            stageInMode = 'copy'
            stageOutMode = 'copy'
            beforeScript = 'set -x; pwd; hostname; env | sort'
            afterScript = 'set -x; ls -al'
            withLabel: cpu {
                cpus = 36
            }
            withLabel: gpu {
                clusterOptions = "--constraint='v100'"
            }
            withLabel: img {
                // cpus = 60
                clusterOptions = '--constraint=clx&nogpu'
            }
        }
        params {
            outdir = '/data/curtin_mwaeor/data'
            proxy_prelude = 'export http_proxy="http://proxy.per.dug.com:3128" https_proxy="http://proxy.per.dug.com:3128" all_proxy="proxy.per.dug.com:3128" ftp_proxy="http://proxy.per.dug.com:3128"'
            astro_conda = '/data/curtin_mwaeor/sw/conda/dev'

            // sifs
            birli_sif = '/data/curtin_mwaeor/sw/singularity/birli/birli_mwaf.sif'
            mwa_qa_sif = '/data/curtin_mwaeor/sw/singularity/mwa_qa/mwa_qa_latest.sif'
            cotter_sif = '/data/curtin_mwaeor/sw/singularity/cotter/cotter_latest.sif'
            casa_sif = '/data/curtin_mwaeor/sw/singularity/casa/casa_latest.sif'

            // binaries
            hyperdrive = '/data/curtin_mwaeor/sw/bin/hyperdrive'
            birli = "singularity exec --bind \$PWD:/tmp --writable-tmpfs --pwd /tmp --home \$PWD --cleanenv ${params.birli_sif} /opt/cargo/bin/birli"
            giant_squid = '/data/curtin_mwaeor/sw/bin/giant-squid'
            jq = '/data/curtin_mwaeor/sw/bin/jq'
            wsclean = '/data/curtin_mwaeor/sw/bin/wsclean'
            // wsclean = '/data/curtin_mwaeor/sw/wsclean/3.1-knl-icc/bin/wsclean'
            // wsclean = 'module use /data/curtin_mwaeor/sw/modules; module load wsclean/3.1-knl-icc; /data/curtin_mwaeor/sw/wsclean/3.1-knl-icc/bin/wsclean -j 60'
            // wsclean = 'module use /data/curtin_mwaeor/sw/modules; module load wsclean/3.1-knl-icc; mpirun -np 30 /data/curtin_mwaeor/sw/wsclean/3.1-knl-icc/bin/wsclean-mp'
            casa = "singularity exec --bind \$PWD:/tmp --writable-tmpfs --pwd /tmp --home \$PWD --cleanenv ${params.casa_sif} /usr/bin/casa"
            ps_metrics = "/data/curtin_mwaeor/src/chips/src/ps_metrics"

            // calibration
            sourcelist = '/data/curtin_mwaeor/data/srclist_pumav3_EoR0LoBESv2_fixedEoR1pietro+ForA_phase1+2_edit.txt'
            beam_path = '/data/curtin_mwaeor/data/mwa_full_embedded_element_pattern.h5'
            // todo: can't determine this from nvidia-smi
            // cuda_compute = 80 // a100
            cuda_compute = 70 // v100
            num_gpus = 1
        }
    }
    sirius {
        process {
            scratch = '/tmp/mwaeor'
            executor = 'local'
        }
        params {
            outdir = '/data/dev'
            hyperdrive = '/usr/local/bin/hyperdrive'
            sourcelist = '/data/dev/calibration/srclist_pumav3_EoR0LoBESv2_fixedEoR1pietro+ForA_phase1+2.txt'
            beam_path = '/data/dev/calibration/mwa_full_embedded_element_pattern.h5'
            cuda_compute = 75
        }
    }
}